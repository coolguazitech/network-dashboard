# 客戶端比較頁面重新設計

## 現有問題

1. 折線圖顯示「每個時間點的異常數趨勢」沒有實際意義
2. 用戶無法清楚選擇 Checkpoint 作為比較基準
3. 比較邏輯與需求不符

## 核心概念

### 資料結構

- **Snapshot（快照）**：每 30-60 秒 Job Scheduler 撈取的一次完整資料
- **Checkpoint（檢查點）**：每整點的快照，可被用戶選為 "Before" 比較基準
- **Before**：用戶選擇的 Checkpoint，作為比較基準
- **Current**：最新的 Snapshot，與 Before 進行比較

### 比較邏輯

1. 用戶選擇一個 Checkpoint 作為 Before
2. 系統自動取最新 Snapshot 作為 Current
3. 比較 Before vs Current：
   - 有變化 + 不符合設備對應規則 → 異常
   - 未偵測（Before 有、Current 沒有，或反之）→ 異常
   - 有變化 + 符合設備對應規則 → 正常
   - 無變化 → 正常

### 即時更新

- 當新 Snapshot 生成時，自動重新比較並更新前端
- 前端可用 WebSocket 或 Polling（每 30 秒）更新

---

## 新 UI 設計

### 1. 頁面標題區

```
客戶端比較
依照 Checkpoint 比較 MAC 設備在不同時間點的變化
```

### 2. 歲修進度區

顯示：
- 歲修開始時間
- 目前進度（Day X / 7）
- 進度條

### 3. Checkpoint 選擇區

```
┌─────────────────────────────────────────────────────────────┐
│ 選擇比較基準 (Before Checkpoint)                             │
│                                                             │
│ ● 01/30 20:00  ○ 01/30 21:00  ○ 01/30 22:00  ○ 01/30 23:00 │
│ ○ 01/31 00:00  ○ 01/31 01:00  ○ 01/31 02:00  ...           │
│                                                             │
│ 已選擇: 01/30 20:00 (2 天前)                                │
└─────────────────────────────────────────────────────────────┘
```

- 整點時間點以小圓點/按鈕呈現
- 點擊選擇作為 Before
- 顯示目前選擇的時間

### 4. 分類統計卡片

```
┌─────────────────────────────────────────────────────────────┐
│ 對比結果 (Before: 01/30 20:00 → Current: 01/31 17:15:30)   │
│                                                             │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│ │ 全部    │ │ 機台A   │ │ 機台B   │ │ 未分類  │            │
│ │ 5 異常  │ │ 2 異常  │ │ 1 異常  │ │ 2 異常  │            │
│ │ 10 總數 │ │ 4 總數  │ │ 3 總數  │ │ 3 總數  │            │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘            │
│                                                             │
│ 最後更新: 01/31 17:15:30 (每分鐘自動更新)                   │
└─────────────────────────────────────────────────────────────┘
```

### 5. 詳細資料列表

```
┌─────────────────────────────────────────────────────────────┐
│ 詳細變化列表                                    🔍 搜尋 MAC │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ AA:BB:CC:DD:EE:01 [機台A]                               ││
│ │   速率: 100M → 1G | 雙工: half → full     🟡 警告      ││
│ ├─────────────────────────────────────────────────────────┤│
│ │ AA:BB:CC:DD:EE:02 [未分類]                              ││
│ │   偵測狀態: 未偵測 → 已偵測                 🟡 警告      ││
│ ├─────────────────────────────────────────────────────────┤│
│ │ AA:BB:CC:DD:EE:03 [機台A]                               ││
│ │   交換機: SW-OLD → SW-NEW (符合對應)        ✓ 正常      ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ 共 10 筆 | 顯示: 全部狀態 ▼ | 每頁 25 ▼                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 後端 API 調整

### 1. 獲取 Checkpoints 列表

```
GET /api/v1/comparisons/checkpoints/{maintenance_id}
```

返回：
```json
{
  "maintenance_id": "STEP-TEST-001",
  "start_time": "2026-01-30T00:00:00",
  "checkpoints": [
    {"timestamp": "2026-01-30T20:00:00", "label": "01/30 20:00"},
    {"timestamp": "2026-01-30T21:00:00", "label": "01/30 21:00"},
    ...
  ]
}
```

### 2. 獲取比較結果（Before vs Current）

```
GET /api/v1/comparisons/diff/{maintenance_id}?before_time=2026-01-30T20:00:00
```

返回：
```json
{
  "maintenance_id": "STEP-TEST-001",
  "before_time": "2026-01-30T20:00:00",
  "current_time": "2026-01-31T17:15:30",
  "summary": {
    "total": 10,
    "has_issues": 5,
    "by_category": [
      {"id": null, "name": "未分類", "total": 3, "issues": 2},
      {"id": 1, "name": "機台A", "total": 4, "issues": 2},
      ...
    ]
  },
  "results": [
    {
      "mac_address": "AA:BB:CC:DD:EE:01",
      "category": "機台A",
      "is_changed": true,
      "severity": "warning",
      "differences": {"speed": {"before": "100M", "current": "1G"}},
      ...
    },
    ...
  ]
}
```

### 3. 即時更新機制

選項 A：Polling（簡單）
- 前端每 30-60 秒呼叫 `/comparisons/diff` API

選項 B：WebSocket（即時）
- 後端在新 Snapshot 生成時推送更新

---

## 實作步驟

### Phase 1: 後端調整

1. [ ] 新增 Checkpoint 表或邏輯（標記整點快照）
2. [ ] 調整 `/comparisons/checkpoints` API
3. [ ] 調整 `/comparisons/diff` API（Before vs Current 比較）
4. [ ] 確保 Job Scheduler 正確生成快照

### Phase 2: 前端重寫

1. [ ] 移除折線圖
2. [ ] 新增歲修進度顯示
3. [ ] 新增 Checkpoint 選擇器
4. [ ] 調整分類統計卡片（對比 Before）
5. [ ] 調整詳細資料列表
6. [ ] 實作自動更新（Polling 或 WebSocket）

### Phase 3: 測試

1. [ ] 測試 Checkpoint 選擇功能
2. [ ] 測試比較邏輯正確性
3. [ ] 測試即時更新功能

---

## 待確認問題

1. **Checkpoint 間隔**：目前定義為整點，是否需要調整？
2. **即時更新方式**：Polling 還是 WebSocket？
3. **歷史資料保留**：7 天後 Checkpoint 是否刪除？
4. **預設 Before**：用戶未選擇時，預設使用哪個 Checkpoint？
